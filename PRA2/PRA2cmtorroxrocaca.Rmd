---
title: "**Pràctica 2: Com realitzar la neteja i l'anàlisi de dades?**"
author: "Carlos Martínez Torró (cmtorro@uoc.edu) i Xavier Roca Canals (xrocaca@uoc.edu)"
date:  "`r format(Sys.time(), '%d/%m/%Y')`"
output:
  pdf_document:
    toc: yes
    highlight: tango
  html_document:
    toc: yes
    
toc-title: "Índex de la pràctica"
---

\newpage

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
```

```{r load_libraries, include=FALSE}
library(knitr)
library(ggplot2)
library(tidyverse)
library(kableExtra)
library(dplyr)
library(car)
library(ggpubr)
library(corrplot)
library(rminer)
library(caret)
```



# Exercici 1: Descripció del dataset

[El nostre dataset](https://zenodo.org/record/7343400) recopila desenes de mètriques estadístiques de més de 70 temporades de la NBA i de 25 anys de la WNBA, és a dir, des dels inicis respectius de cada lliga. Les dades es van recollir del web [Basketball Reference](https://www.basketball-reference.com/) (propietat del grup Sports Reference) i  estan classificades per equip i per temporada, amb un total de 1900 observacions i 53 variables. És a dir, a cada fila trobarem com li ha anat a un equip, des del punt de vista mètric, en una temporada en concret. L'ampla disponibilitat de variables ens permet anar des dels anàlisis més superficials (victòries, derrotes, punts a favor...) a altres més complexos (ritme de joc, eficiència dels llançaments...). 

En una era com la nostra en la que les dades s'han infiltrat arreu, ens preguntem si també han arribat a la lliga de bàsquet per excel·lència. L'objectiu que perseguim amb la creació i l'actual anàlisi d'aquest dataset és ambiciós: es pot explicar l'evolució de la NBA a través de les estadístiques? Hi ha algun patró que segueixin aquells equips més exitosos? I estan dirigint aquests equips l'evolució de l'esport?

# Exercici 2: Integració i selecció de les dades
A la Pràctica 1 ja vam realitzar una integració de diferents datasets creats a partir del _web scraping_, ja que estàvem interessats en diferents taules i vam optar per fer un dataframe per cadascuna d'elles i després unir els dataframes resultants per les columnes comunes (amb la funció `merge` de la llibreria `pandas`). Per tant, el dataset lliurat a la PRA1 és el que carregarem.


```{r}
# Carreguem les dades amb read.csv:
df <- read.csv("../dataset/NBA_WNBA_statistical_evolution.csv")
```

Com posar la sortida de les funcions `head`, `summary` o `str` pot allargar molt el document i resultar improductiu degut a l'elevat nombre de variables que tenim, podem crear una taula per veure la informació bàsica del dataset: quantes observacions tenim, quantes variables, quantes són numèriques, quantes categòriques, etc.

```{r}
# Carreguem kableExtra per fer la taula amb la informació bàsica. També 
# carreguem dplyr per ajudar-nos amb el filtratge de les dades:


# Traiem les dades bàsiques del dataset:
cols <- ncol(df)
rows <- nrow(df)

# Informació del tipus de variables:
catCols <- length(names(df)[sapply(df, is.character)])
numCols <- length(names(df)[sapply(df, is.numeric)])

# I informació respecte als valors nuls, primer per cada fila:
compObs <- nrow(df %>% filter(complete.cases(.)))
compObsPct <- paste(compObs, '/', rows, ' = ', 
                      round(((compObs/rows) * 100), 2), '%')

# I per les variables:
comVars <- df %>% select_if(~ all(!is.na(.))) %>% length()
comVarsPct <- paste(comVars, '/', cols, ' = ', 
                    round(((comVars/cols) * 100), 2), '%')

# Definim el que hi haurà al dataframe:
mets <- c("Nombre d'observacions", "Nombre de variables", "Variables numèriques", 
          "Variables categòriques", "Casos complets (%) (observacions sense NAs)", 
          "Variables completes (%) (variables sense NAs)")
vals <- c(rows, cols, numCols, catCols, compObsPct, comVarsPct)

# Ho passem tot a un dataframe i formatem la taula amb Kable:
resum <- data.frame(mets, vals)
kable(resum, booktabs = TRUE, caption = "Mètriques bàsiques del dataset", 
      col.names = c("Mètrica", "Valor")) %>% 
  kable_styling(latex_options = c("striped", "hold_position"))

```

Com podem veure a la taula, hi ha un gran percentatge de casos complets (és a dir, equips amb tota la informació de l temporada completa), mentre que aproximadament el 60% de les variables no tenen cap valor NA. Podem fer una ullada a quines són les variables amb més valors perduts del nostre dataset.  

```{r}
# Apliquem sapply per obtenir els valors perduts per variable:
nas <-sapply(df, function(y) sum(length(which(is.na(y)))))

# Creem un dataframe amb els valors:
nas <- data.frame(nas)
nas <- cbind(variables = rownames(nas), data.frame(nas, row.names=NULL))

# Ordenem per valor més alt de NA:
nas <- nas[order(nas$nas, decreasing = TRUE), ]
rownames(nas) <- NULL

# Ho formatem amb kable:
kable(head(nas, 10), booktabs = TRUE, caption = "Variables amb més valors perduts", 
      col.names = c("Variable", "Valors NA")) %>% 
  kable_styling(latex_options = c("striped", "hold_position"))

```

Veiem que algunes d'aquestes variables estan relacionades amb el llançament de tres punts. Això és degut a que fins 1979 no existia aquest llançament, així que hi ha gairebé trenta anys de registres on aquestes variables tenen valor nul per definició. Per altra banda, algunes mètriques com els rebots ofensius (variable _orb_) o defensius (variable _drb_) i les pèrdues (com el percentatge del propi equip amb la variable _tov_pct_ o del contrari amb _opp_tov_pct_) també van ser estadístiques que no es recollien originalment, així que és normal que hi hagi valors perduts en aquestes. De fet, si filtrem i només agafem les observacions posteriors a la temporada 1978-79 (el llançament de tres va començar a la 1979-80) veurem que el nombre de valors perduts és molt diferent:

```{r}
df2 <- df %>% filter(Season > "1978-79")
cat("Valors perduts després de la temporada 1978-79:", sum(is.na(df2)))

```


# Exercici 3: Neteja de les dades

Com bé hem comentat en l'anterior apartat, trobem temporades en les quals ens falta informació sobre estadístiques bàsiques sobre el joc. D'aquesta forma, ens dificulta l'anàlisi sobre aquestes temporades, ja que no disposem dels elements bàsics per entendre com era l'estil o funcionament de joc de cada equip. En conseqüència, s'ha decidit descartar aquestes temporades.

## 3.1: Les dades contenen zeros o elements buits?

Així i tot, trobem temporades més antigues a l'aparició del tir de tres punts que si disposen d'aquestes estadístiques. Observant el conjunt de dades, trobem que a partir de la temporada 1973-74 disposem de tota la informació necessària. Així i tot, analitzarem quins valors buits disposem en el nostre conjunt de dades a partir d'aquesta temporada.
```{r}
df3 <- df %>% filter(Season > "1973-74")
sort(colSums(is.na(df3)), decreasing = TRUE)
```

Com era d'esperar, les úniques variables que observem amb valors buits són les que fan referència als tirs de tres punts. El que farem, és omplir aquests valors buits amb el valor 0, ja que s'ha decidit que és el valor que realment representa aquests camps. Com no existia el tir de tres no es van realitzar cap tir.

```{r}
df3$fg3[is.na(df3$fg3)] <- 0
df3$fg3_pct[is.na(df3$fg3_pct)] <- 0
df3$fg3a[is.na(df3$fg3a)] <- 0
df3$fg3a_per_fga_pct[is.na(df3$fg3a_per_fga_pct)] <- 0
```

Un altre fet a tenir en compte, és el camp `gb`. Aquesta variable ens mostra quants partits té cada equip per darrere del rival que ocupa el primer lloc. En alguns casos, aquesta informació ve representada amb el valor `-`. Entenem que aquest valor, fa referència al fet que no té cap partit per darrere dels rivals (és a dir, és l'equip que va primer de la seva divisió) i el seu valor real és 0.

```{r}
df3$gb <- as.numeric(df3$gb)
df3$gb[is.na(df3$gb)] <- 0
```

## 3.2: Identifica i gestiona els valors extrems.
En aquest cas, a partir de la funció 'summary' podem observar els mínims i màxims valors de cada variable. No s'exemplificarà en el document, ja que el gran volum de variables dificultaria la lectura del document de la pràctica. Així i tot, un cop comprovat aquest, sí que podem trobar valors molt petits en comparació a la mitjana, com pot ser el cas de victòries que ha assolit un equip en una temporada.

Ho podem veure en aquest petit exemple:
```{r}
summary(df3$wins)
```

És normal, que ens podem trobar aquests casos en múltiples variables, ja que en una mateixa temporada, els equips guanyadors presentaran valors màxims en victòries i els perdedors mínims en aquestes. En conseqüència, també es veurà reflectit en les estadístiques d'aquests equips.

El que s'ha decidit és no realitzar cap modificació, ja que aquests valors són correctes perquè es basen en dades reals sobre les temporades i les estadístiques de joc de cada un dels equips. Per tant, hem d'assumir que serà possible trobar valors que siguin _outliers_, però que haurem de tractar com un valor més. 

# Exercici 4: Anàlisi de les dades
Abans de començar amb l'anàlisi, haurem de tenir en compte que els valors absoluts ens poden portar a error i que haurem d'optar, en general, pels relatius (percentatges o mètriques ajustades per partit o possessions). Això és degut a que la NBA i la WNBA tenen un nombre de partits totals diferents, però també perquè la pròpia NBA ha evolucionat en aquest aspecte: en el seu inici es jugaven molts menys partits. Veiem-ho amb un gràfic, on utilitzarem les dades de partits des de 1973:

```{r fig.height=3, fig.width=8}
library(ggplot2)
# Creem la columna 'games' per guardar la informació del total de partits que ha jugat cada equip:
df3$games <- df3$wins + df3$losses

# Fem el gràfic:
ggplot(df3, aes(x=games, color=League, fill=League)) +
geom_histogram(aes(y=..density..), position="identity", alpha=0.5)+
geom_density(alpha=0.6)+
scale_color_brewer(palette="Dark2")+
scale_fill_brewer(palette="Dark2") +
labs(title="Histograma dels partits per temporada a la NBA i la WNBA",
     x="Partits per temporada", y = "Densitat")+
theme_classic()
```

Com es pot veure, en general les temporades a la NBA han tingut més de 80 partits, però no sempre ha sigut així. Pel que fa a la WNBA, hi ha més variació en aquest número de partits, però es troba al voltant dels 30. És per això que, en cas d'utilitzar valors absoluts, haurem de comprovar prèviament que estiguem comparant entre temporades amb el mateix número de partits. 

Pel que fa als subapartats de l'exercici en sí, hem decidit que, per facilitar la lectura, els farem consecutius per a cadascuna de les tres preguntes que ens hem plantejat. És a dir, farem la selecció, comprovació de normalitat i les aplicacions dels estadístics de forma contínua per a cada anàlisi, amb la idea de mantenir el fil i els raonaments particulars fins acabar l'anàlisi. 


## Anàlisi 1: ha canviat la preferència dels llançaments?
La introducció dels llançaments de tres a la lliga l'any 1979 va suposar un abans i un després a l'hora de jugar l'esport. No obstant, un espectador que no hagi vist res de bàsquet en els darrers 20 anys es podria sorprendre amb la quantitat aparent de llançaments de tres que es practiquen avui en dia. Amb l'aparició de fenòmens com Stephen Curry, el joc sembla haver canviat en els darrers anys. 

### Anàlisi 1.1: Selecció de les dades que es volen analitzar/comparar
Per analitzar-ho millor, farem un anàlisi dècada per dècada dels llançaments de tres. Ens fixarem en una variable en concret: `fg3a_per_fga_pct`. Aquesta variable indica (en percentatge) quants llançaments de tres ha realitzat un equip de tots els llançaments intentats. És a dir, si de 10 tirs de camp, 4 són triples, parlarem d'un 40% (en la variable estaria codificat com a 0.4). Triem aquesta variable en comptes del nombre de triples perquè ens pot donar una idea millor de si ha variat la selecció de llançaments.

Així doncs, farem quatre grups diferents: del 79 fins el 90, del 90 fins el 2000, del 2000 fins el 2010 i del 2010 fins l'actualitat. Ho codificarem tot en una nova variable, que anomenarem `decade`:

```{r}
# Creem la nova variable amb case_when:
df <- df %>% mutate(decade = case_when(
  Season > "1978-79" & Season < "1989-90" ~ "80s",
  Season > "1988-89" & Season < "1999-00" ~ "90s",
  Season > "1988-99" & Season < "2009-10" ~ "00s",
  Season > "2008-09" ~ "10s",
  TRUE ~ "Pre-three era"
))

df$decade <- factor(df$decade, levels = c("Pre-three era", "80s", "90s", "00s", "10s"))
```

Amb un boxplot podem comparar les èpoques a primera vista:

```{r fig.height=4, fig.width=8}
# Grafiquem, excloent abans les temporades sense llançaments de tres:
ggplot(df %>% filter(decade != "Pre-three era"), 
       aes(x=decade, y=fg3a_per_fga_pct*100, fill=League)) + geom_boxplot() + 
  labs(title = "Llançaments de tres intentats respecte el total per dècada", 
       x = "Dècada", y = "FG3A/FGA (%)") + scale_fill_brewer(palette="RdBu") +
  theme_classic()
```

Veiem que, efectivament, hi ha una tendència a llançar més de tres amb els anys. Utilitzem ara un gràfic de dispersió per a observar aquesta tendència amb el pas de les temporades:

```{r fig.height=4, fig.width=8}
ggplot(df %>% filter(decade != "Pre-three era"), 
       aes(x=Season, y = fg3a_per_fga_pct*100, color = decade)) + 
  geom_point(size=0.7) + 
  labs(title = "Tendència de llançaments de tres intentats amb el pas dels anys", 
       x = "Temporada", y = "FG3A/FGA (%)") + 
  scale_x_discrete(breaks = c("1979-80", "1989-90", "1999-00", "2009-10", "2021-22")) +
  guides(colour = guide_legend(override.aes = list(size = 3))) + theme_classic()
```

Notablement, sembla que aquest percentatge es manté en un rang similar des de mitjans dels 90 fins mitjans de la dècada dels 2010s, on comença a pujar. Hi ha un equip, fins i tot, que va sobrepassar el 50% de llançaments de tres del total de llançaments.

```{r}
df3max <- df[which.max(df$fg3a_per_fga_pct),] %>% select(Season, Team, wins, losses, Playoffs, fg3a_per_fga_pct, fg3_pct)
rownames(df3max) <- NULL
kable(df3max, booktabs = TRUE, 
      caption = "Equip amb el valor màxim de llançaments de tres intentats 
      respecte el total de llançaments") %>% 
  kable_styling(latex_options = c("striped", "hold_position"))
```

### Anàlisi 1.2: Comprovació de la normalitat i homogeneïtat de la variància
Passarem ara a fer l'anàlisi estadístic d'aquestes dades. Abans, però, haurem de comprovar la normalitat per saber si haurem d'aplicar un test paramètric o un no paramètric. 

```{r}
norm3 <- df %>% filter(decade != "Pre-three era") %>%
  group_by(decade) %>%
  summarise(statistic = shapiro.test(fg3a_per_fga_pct)$statistic,
            p.value = shapiro.test(fg3a_per_fga_pct)$p.value)

norm3 <- as.data.frame(norm3)

kable(norm3, booktabs = TRUE, 
      caption = "Test de Shapiro-Wilk per avaluar normalitat de la mostra") %>% 
  kable_styling(latex_options = c("striped", "hold_position"))
```

Com es pot veure a la taula, el p-valor és en tots els casos molt inferior a 0.05, el que permet refutar la hipòtesi nul·la que assumeix una distribució normal. Per tant, podem dir que cap de les quatre mostres avaluades té una distribució normal per la variable `fg3a_per_fga_pct`. 

Pel que fa a la variància, podem comparar les variàncies amb el test de Bartlett o el test de Levene. 

```{r}
# Fem els tests:
bar <- bartlett.test(fg3a_per_fga_pct ~ decade, data = df %>% filter(decade != "Pre-three era"))
lev <- leveneTest(fg3a_per_fga_pct ~ decade, data = df %>% filter(decade != "Pre-three era"))

# Ho passem a dataframe:
varCheck <- data.frame("Test" = c("Test de Bartlett", "Test de Levene"), "p-valor" = c(bar$p.value, lev$`Pr(>F)`[1]))

# Fem la taula:
kable(varCheck, booktabs = TRUE, 
      caption = "Avaluació de l'homoscedasticitat amb els tests de Bartlett i Levene") %>% 
  kable_styling(latex_options = c("striped", "hold_position"))
```

Podem comprovar mirant els p-valors d'ambdós tests que les mostres no tenen la mateixa variància, ja que en ambdós casos refutem la hipòtesi nul·la de igualtat de variàncies. 

### Anàlisi 1.3: Aplicació de proves estadístiques per comparar els grups de dades.
Per tant, tenim mostres on no hi ha una distribució normal dels valors i tampoc tenim una situació de homoscedasticitat. No obstant, com tenim una mostra força gran, podem aplicar el **teorema del límit central**, ja que, degut a la mida de la mostra, podem assumir que si fem les mitjanes aritmètiques de diferents mostrejos aleatoris, la distribució d'aquestes mitjanes aritmètiques serà gaussiana. 

```{r}
dec <- count(df, decade)
kable(dec, booktabs = TRUE, caption = "Nombre d'observacions que tenim per dècada", 
      col.names = c("Dècada", "Observacions")) %>% 
  kable_styling(latex_options = c("striped", "hold_position"))
```

Pel que fa a la variància, podem aplicar el test de Welch, que és una alternativa a l'ANOVA clàssic quan no hi ha homoscedasticitat. Així doncs, mirarem si hi ha diferències entre les diferents dècades pel que fa al percentatge de llançaments de tres respecte el total de llançaments fets. 

```{r}
welch <- oneway.test(fg3a_per_fga_pct ~ decade, data = df %>% filter(decade != "Pre-three era"), var.equal = F)
welDF <- data.frame("Test" = "ANOVA de Welch", "p-valor" = welch$p.value)
kable(welDF, booktabs = TRUE, 
      caption = "Test de Welch per avaluar diferència entre els llançaments de tres respecte el total per cada dècada") %>% 
  kable_styling(latex_options = c("striped", "hold_position"))

```

El p-valor de 0 ens indica que hi ha diferències. Ara bé, entre quins grups? Per saber-ho, necessitem fer un test _post hoc_. Podem utilitzar el test de Games-Howell, similar al test de Tukey (un dels més comuns), però aquest no assumeix igualtat de variàncies.

```{r}
library(rstatix)
# Realitzem el test:
gh <- games_howell_test(df %>% filter(decade != "Pre-three era"), 
                  fg3a_per_fga_pct ~ decade, conf.level = 0.95, detailed = F)

# Ho passem a dataframe:
ghDF <- as.data.frame(gh)

# Passem la columna p.adj a caràcter per no perdre decimals:
ghDF$p.adj <- as.character(ghDF$p.adj)

# Fem la taula:
kable(ghDF[, c(2, 3, 7)], booktabs = TRUE, caption = "Diferències entre dècades en el percentatge de llançament de tres respecte als llançaments total", 
      col.names = c("Grup 1", "Grup 2", "p-Valor ajustat")) %>% 
  kable_styling(latex_options = c("striped", "hold_position"))

```

Així, veiem que hi ha diferències significatives entre tots els grups. No obstant, veiem que les diferències entre els 90s i els 2000s i entre els 2000s i els 2010s són menors que entre les altres dècades, un fet que podíem intuir amb la representació gràfica d'aquesta variable.

## Anàlisi 2: ha canviat l'estil de joc durant els anys?
Dins de l'NBA, cadascun dels equips que han competit o encara competeixen han desenvolupat un estil de joc característic a partir d'aprofundir i millorar en certes capacitats ofensives/defensives que els ha permès aconseguir victòries i obtenir el rendiment desitjat. A més, cada època en concret té les seves peculiaritats pròpies, ja sigui per les regles del moment, pels equips dominadors o per grans estrelles que obliguen als equips a evolucionar per adaptar-se. 

### Anàlisi 2.1: Selecció de les dades que es volen analitzar/comparar
Com disposem d'un gran nombre de variables, ens hem preguntat si podríem veure, amb l'ajuda d'aquestes, si ha canviat la forma de jugar en les últimes dècades de la lliga. Amb aquesta idea al cap, volem saber si la correlació entre algunes de les variables més importants ha anat canviant amb els anys o si, pel contrari, s'ha mantingut constant. A més, també ens preguntem quina és la correlació entre aquestes variables i les victòries aconseguides durant la temporada en funció de l'època, amb l'objectiu final de veure si quines variables es correlacionen més fortament amb les victòries. 

Per tant, les variables a utilitzar es tracten de les estadístiques més bàsiques que s'han aconseguit sobre el joc.

```{r}
# Seleccionem les variables:
vars <- c("win_loss_pct","age", "off_rtg","def_rtg","fg","fg2","fg3","ft","orb","drb", "ast", "stl", "blk", "tov", "pf")
description <- c("percentatge de victòries",
                 "mitjana d'edat",
                 "classificació ofensiva",
                 "classificació defensiva",
                 "mitjana de tirs de camp",
                 "mitjana de tirs de dos punts",
                 "mitjana de tirs de tres punts",
                 "mitjana de tirs lliures",
                 "mitjana de rebots ofensius",
                 "mitjana de rebots defensius",
                 "mitjana d'assistències",
                 "mitjana de pilotes robades",
                 "mitjana de bloquejos",
                 "mitjana de pilotes perdudes",
                 "mitjana de faltes personals")

# Fem la taula:
vars21 <- data.frame(variables = vars, desc = description)
kable(vars21, booktabs = TRUE, caption = "Variables seleccionades per la correlació", 
      col.names = c("Variable", "Descripció de la variable")) %>% 
  kable_styling(latex_options = c("striped", "hold_position"))
```

### Anàlisi 2.2: Correlació entre les estadístiques més bàsiques
Seguidament, comprovarem quina correlació poden tenir totes aquestes variables entre si, i entendre quin estil de joc predomina durant cada època dins de l'NBA i WNBA. No obstant, abans de començar amb les correlacions haurem de veure la distribució d'aquestes variables, ja que depenent de si hi ha normalitat o no haurem d'aplicar un mètode o un altre (per exemple, la correlació de Pearson és paramètrica, mentre que la $\tau$ de Kendall i la $\rho$ de Spearman són no paramètriques). Com la nostra intenció és veure l'evolució en diferents eres, mirarem la distribució d'aqustes mostres en funció de l'era i la lliga:

```{r}
norm22 <- df %>% filter(decade != "Pre-three era") %>% 
    gather(key = "varname", value = "value", vars) %>% 
    group_by(varname, decade, League)  %>% 
    do(tidy(shapiro.test(.$value))) %>% 
    ungroup() %>% 
    select(-method)



kable(head(norm22[order(norm22$p.value, decreasing = TRUE), ]), booktabs = TRUE, 
      caption = "Normalitat de les variables en funció de la dècada i la lliga (primeres files)", 
      col.names = c("Variable", "Descripció de la variable", "f", "f", "p-valor")) %>% 
  kable_styling(latex_options = c("striped", "hold_position")) %>% 
  footnote("Ordenats per p-valor descendent")

norm22cols <- nrow(norm22)
higher05 <- sum(norm22$p.value >= 0.05)
lower05 <- sum(norm22$p.value < 0.05)
normSum <- data.frame(param = c("Total d'observacions", "Superior a 0.05", "Inferior a 0.05"),
                      value = c(norm22cols, higher05, lower05))

kable(normSum, booktabs = TRUE, 
      caption = "Resum de les distribucions de les variables en funció del seu p-valor", 
      col.names = c("Paràmetre", "Nombre d'observacions")) %>% 
  kable_styling(latex_options = c("striped", "hold_position"))


```

Veiem que aproximadament un terç de les distribucions no són gaussianes, ja que refutem la hipòtesi nul·la en 32 dels 105 casos. 

### Anàlisi 2.3: Aplicació de proves estadístiques 
Com algunes de les mostres que volem comparar no tenen distribució normal, hem d'utilitzar un mètode no paramètric, en comptes d'utilitzar la típica correlació de Pearson. En aquest cas, farem servir el mètode de correlació per rangs de Spearman, que és un mètode no paramètric.

```{r Correlació de Spearman, fig.width = 8, fig.height = 8, fig.align = "center", out.width = "110%"}
# Fem una correlació per cada dècada i guardem els gràfics en una nova variable:
par(mfrow=c(2,2), oma=c(0,0,3,0))

# Definim els colors
col <- colorRampPalette(c("#BB4444", "#EE9988", "#FFFFFF", "#77AADD", "#4477AA"))

# Fem les correlacions i els gràfics:
df80s <- df %>% filter(decade == "80s")
cor80 <- cor(df80s[, vars], method = "spearman")
cor80plot <- corrplot(cor80, method = "color", col = col(200), addCoef.col = 'black', type = "upper", tl.srt = 45, tl.col = "black", tl.cex = 0.7, cl.pos = 'n', diag = F, number.font = 1, number.cex = 0.6, title = "80s",  mar=c(0,0,1,0))

df90s <- df %>% filter(decade == "90s")
cor90 <- cor(df90s[, vars], method = "spearman")
cor90plot <- corrplot(cor90, method = "color", col = col(200), addCoef.col = 'black', type = "upper", tl.srt = 45, tl.col = "black", tl.cex = 0.7, cl.pos = 'n', diag = F, number.font = 1, number.cex = 0.6, title = "90s",  mar=c(0,0,1,0))

df00s <- df %>% filter(decade == "00s")
cor00 <- cor(df00s[, vars], method = "spearman")
cor00plot <- corrplot(cor00, method = "color", col = col(200), addCoef.col = 'black', type = "upper", tl.srt = 45, tl.col = "black", tl.cex = 0.7, cl.pos = 'n', diag = F, number.font = 1, number.cex = 0.6, title = "00s",  mar=c(0,0,1,0))

df10s <- df %>% filter(decade == "10s")
cor10 <- cor(df10s[, vars], method = "spearman")
cor10plot <- corrplot(cor10, method = "color", col = col(200), addCoef.col = 'black', type = "upper", tl.srt = 45, tl.col = "black", tl.cex = 0.7, cl.pos = 'n', diag = F, number.font = 1, number.cex = 0.6, title = "10s",  mar=c(0,0,1,0))

# Posem el títol:
title(main = "Correlació entre algunes de les principals mètriques segons la dècada", cex.main = 1.2,   font.main = 2, col.main= "black", 
      outer = TRUE)

```

Destaquem algunes coses d'aquestes correlacions:

* **Anys 80**: la correlació positiva més forta amb el percentatge de victòries és amb el _rating_ ofensiu, mentre que la més negativa és amb el _rating_ defensiu (la qual cosa té sentit, ja que les millors defenses tindran _ratings_ defensius menors, mentre que les pitjors tindran un valor més elevat d'aquesta mètrica). En aquesta dècada també trobem la correlació més forta entre aquest percentatge i l'encert en els llançaments (tant totals com de dos, representats a les variables _fg_ i _fg2_, respectivament). Hi ha un parell d'aspectes curiosos d'aquesta època quan la comparem amb les altres:
  
  * El _rating_ ofensiu està correlacionat positivament sobretot amb l'encert en els llançaments i les assistències, però la resta de correlacions són dèbils (traient les pèrdues de pilotes o _tov_, que correlacionen negativament amb aquest _rating_ a totes les èpoques). En altres èpoques, veiem per exemple una relació més forta amb el _rating_ defensiu (especialment a partir dels 2000), el que ens suggeriria que els millors atacs també impliquen encaixar més punts. També hi ha una correlació més gran de les assistències en les èpoques posteriors als 80, el que podria tenir sentit ja que el joc es torna més col·laboratiu i menys individualista amb els anys. 
  * El _rating_ defensiu no té cap correlació positiva forta amb cap altra variable. Té algunes negatives que tenen cert sentit: els rebots defensius, les pilotes robades i els taps. És a dir, estadístiques de caire molt defensiu, motiu pel qual és lògic que aquesta correlació sigui negativa. En altres èpoques, hi ha correlacions positives més fortes amb altres variables, com és el cas del percentatge de llançaments encertats. Com hem dit anteriorment, tenir els millors atacs pot significar també encaixar més punts (pel ritme de partit que imposen, per exemple).
  
* **Anys 90**: l'edat i els _ratings_ ofensius i defensius tenen les correlacions més fortes amb el percentatge de victòries. L'edat és un factor que correlaciona positivament amb les victòries en totes les èpoques, però en aquesta és on la correlació és més forta. En aquesta dècada ja veiem que el percentatge de llançaments encertats (especialment de dos punts) sembla influir menys en les victòries que en la dècada anterior. Comencem a veure les diferències pel que fa a les correlacions amb els ratings ofensius i defensiu si ho comparem amb els 80. Comencem a veure, per exemple, que capturar més rebots defensius i fer més taps correlaciona positivament amb un _rating_ ofensiu superior. Pel que fa al _rating_ defensiu, veiem que els percentatges d'encert en el llançament ja són un factor molt influent en aquest, mentre que estadístiques defensives com els rebots o les pilotes robades gairebé ja no tenen relació amb ell. Podem començar a intuir canvis en el joc.

* **Anys 2000**: segueix la tendència observada als 90 pel que fa a l'edat i els _ratings_ com principals correlacions amb les victòries. El canvi més important respecte a la dècada passada és la correlació entre els percentatges d'encert en llançaments de tres (variable _fg3_) i el percentatge d'encert de dos (variable _fg_). Aquesta correlació és prou negativa als 80 i força més als 90s. És curiós perquè això ens indicaria que a major percentatge d'encert des del triple, menys percentatge d'encert en els dos punts. Ens podria suggerir que en els 90 van començar a aparèixer els especialistes de tres, és a dir, jugadors que anaven molt bé des de la línia de tres, però no tan bé des de distàncies més curtes. Aquesta correlació és pràcticament 0 als 2000, el que ens diu que no hi ha cap relació entre aquests dos paràmetres. Relacionat amb això, als 2000 és on comença a tenir un pes molt important el percentatge de llançaments de tres en el _rating_ ofensiu i també en el percentatge d'encerts en general. Per tant, en aquesta època, hem analitzat com la capacitat ofensiva evoluciona a partir de l'aparició dels tirs de tres punts. 

* **Anys 2010s fins l'actualitat**: el que més destaca és la importància del triple. Veiem que és l'era on menys correlació hi ha entre l'encert del llançament de dos i l'encert global, el que es pot explicar per la preponderància del tir de tres i la millora en l'encert d'aquest llançament respecte a dècades passades. Destaquem també la correlació entre les assistències i el percentatge d'encert de tres, que és la més positiva en aquesta era. Podríem dir, doncs, Per tant, l'estil de joc de l'NBA, ha evolucionat a partir d'un joc ofensiu que es basava en tirs de dos punts, cap a un estil on els tirs de tres punts tenen un rol central. 



## Anàlisi 3: És possible predir si un equip arribarà o no a playoffs en funció de les seves estadístiques?
En aquest últim estudi, mirarem de realitzar un predictor a partir d'un model supervisat per tal de predir si un equip es pot classificar a playoffs segons les estadístiques recollides durant la temporada. Per aquest cas, tornarem a dividir el conjunt de dades per èpoques, per continuar entenent l'evolució històrica de l'NBA i la WNBA.

### Anàlisi 3.1: Selecció de les dades que es volen analitzar/comparar
Per a seleccionar les variables a utilitzar, mirarem d'afegir el % d'encerts per les estadístiques de tirs de camp. Aquesta ens permet entendre de millor el rendiment de l'equip sobre aquesta estadística. Així i tot, continuarem usant certes variables d'anteriors anàlisis i n'afegirem algunes de noves.

```{r}
view(df)
```


```{r}
# Seleccionem les variables:
vars <- c("age", "fg_pct", "fga", "fg3_pct", "fg3a", "ft_pct", "orb", "drb", "ast", "stl", "tov", "off_rtg", "def_rtg", "pace", "ts_pct", "efg_pct", "opp_efg_pct", "sos")
description <- c("edat mitjana",
                 "percentatge de llançaments de camps encertats",
                 "total de llançaments intentats per partit",
                 "percentatge de llançaments de 3 encertats",
                 "total de llançaments de 3 intentats per partit",
                 "percentatge de tirs lliures encertats",
                 "rebots ofensius per partit",
                 "rebots defensius per partit",
                 "assistències per partit",
                 "pilotes robades per partit",
                 "pilotes perdudes per partit",
                 "rating ofensiu de l'equip",
                 "rating defensiu de l'equip",
                 "Estimació de posessions per partit",
                 "Percentatge True Shooting (tenint en compte tot tipus de llançaments)",
                 "Percentatge de tirs de camp efectius (ajustant pel valor del triple",
                 "Percentatge de tirs de camp efectius de l'oponent",
                 "Dificultat del calendari (nivell dels equips rivals)")

# Fem la taula:
vars21 <- data.frame(variables = vars, desc = description)
kable(vars21, booktabs = TRUE, caption = "Variables seleccionades pel model lineal", 
      col.names = c("Variable", "Descripció de la variable")) %>% 
  kable_styling(latex_options = c("striped", "hold_position"))
```

### Anàlisi 3.2: Preparació dels subconjunts de dades d'entrenament i prova.
Seguidament, haurem de crear els diferents subconjunts de dades per tal d'entrenar el nostre model i posteriorment avaluar-lo. Per realitzar la partició, ens basarem en el mètode d'exclusió (holdout) que ens permet dividir aleatòriament les dades en dos conjunts independents. El que farem serà utilitzar dos terços pel conjunt d'entrenament i el terç restant per les dades de prova.

```{r}
# Convertim la variable Playoffs a factor
df80s$Playoffs.f <- factor(df80s$Playoffs)
df90s$Playoffs.f <- factor(df90s$Playoffs)
df00s$Playoffs.f <- factor(df00s$Playoffs)
df10s$Playoffs.f <- factor(df10s$Playoffs)

# Seleccionem les variables a utilitzar
df80s <- select(df80s, Playoffs.f, vars)
df90s <- select(df90s, Playoffs.f, vars)
df00s <- select(df00s, Playoffs.f, vars)
df10s <- select(df10s, Playoffs.f, vars)

set.seed(12345)

# Dividim el conjunt en els dos subconjunts (entrenament i prova)
h80s <- holdout(y=df80s$Playoffs.f, ratio=2/3, mode="stratified")
train80s <- df80s[h80s$tr,]
test80s <- df80s[h80s$ts,]

h90s <- holdout(y=df90s$Playoffs.f, ratio=2/3, mode="stratified")
train90s <- df90s[h90s$tr,]
test90s <- df90s[h90s$ts,]

h00s <- holdout(y=df00s$Playoffs.f, ratio=2/3, mode="stratified")
train00s <- df00s[h00s$tr,]
test00s <- df00s[h00s$ts,]

h10s <- holdout(y=df10s$Playoffs.f, ratio=2/3, mode="stratified")
train10s <- df10s[h10s$tr,]
test10s <- df10s[h10s$ts,]

dims <- data.frame(conjunt = c("Entrenament", "Test"), 
                   obs = c(nrow(train80s), nrow(test80s)),
                   cols = c(ncol(train80s), ncol(test80s)))

kable(dims, booktabs = TRUE, 
      caption = "Observacions i variables dels conjunts d'entrenament i test dels anys 80", 
      col.names = c("Conjunt", "Nombre d'observacions", "Nombre de variables")) %>% 
  kable_styling(latex_options = c("striped", "hold_position"))
```

En aquest cas, podem observar les dimensions dels primers subconjunts que fan referència a l'època dels 80. Trobem per al subconjunt d'entrenament 154 files amb un total de 19 variables. Així doncs, per al subconjunt de prova, trobem 77 files i 19 variables.

### Anàlisi 3.3: Creació del model i avaluació a partir de la utilització de la regressió logística.

El mètode de model supervisat seleccionat es tracta del model de regressió logística. Aquest ens permetrà predir i classificar la variable categòrica _Playoffs_ per tal de determinar si un equip pot entrar a aquests segons les seves estadístiques. No avaluarem en aquest cas la normalitat ni la variància de les variables ja que els models logístics no assumeixen que les dades segueixen una distribució normal ni tampoc homoscedasticitat. 

Primer de tot, crearem el model a partir del subconjunt d'entrenament i finalment, mirarem de realitzar la predicció amb el subconjunt de prova per tal d'avaluar-lo. Per avaluar, crearem una matriu de confusió per cada una de les èpoques.

```{r}
# Creem els diferents models de regressió logística
d80s.model = glm(Playoffs.f ~., data = train80s, family = binomial)
#summary(d80s.model)

d90s.model = glm(Playoffs.f ~., data = train90s, family = binomial)
#summary(d90s.model)

d00s.model = glm(Playoffs.f ~., data = train00s, family = binomial)
#summary(d00s.model)

d10s.model = glm(Playoffs.f ~., data = train10s, family = binomial)
#summary(d10s.model)

# Creem la predicció i la matriu de confusió sobre els resultats
d80s.prob = predict(d80s.model, test80s, type="response")
d80s.pred = rep("No", dim(train80s)[1])
d80s.pred[d80s.prob > .5] = "Yes"
mat80s <- table(d80s.pred, train80s$Playoffs.f)

d90s.prob = predict(d90s.model, test90s, type="response")
d90s.pred = rep("No", dim(train90s)[1])
d90s.pred[d90s.prob > .5] = "Yes"
mat90s <- table(d90s.pred, train90s$Playoffs.f)

d00s.prob = predict(d00s.model, test00s, type="response")
d00s.pred = rep("No", dim(train00s)[1])
d00s.pred[d00s.prob > .5] = "Yes"
mat00s <- table(d00s.pred, train00s$Playoffs.f)

d10s.prob = predict(d10s.model, test10s, type="response")
d10s.pred = rep("No", dim(train10s)[1])
d10s.pred[d10s.prob > .5] = "Yes"
mat10s <- table(d10s.pred, train10s$Playoffs.f)

```

Seguidament, calcularem el percentatge de registres correctament classificats per cada una de les èpoques.

```{r}
mat80s
kable(mat80s, booktabs = TRUE, 
      caption = "Matriu de confusió amb el model pels anys 80", 
      col.names = c("No", "Yes")) %>% 
  kable_styling(latex_options = c("striped", "hold_position"))
sens <- round(sensitivity(mat80s), 3) * 100
spec <- round(specificity(mat80s), 3) * 100
prec <- round(precision(mat80s), 3) * 100
```

```{r}
params <- c("Sensitivitat", "Especificitat", "Precisió")
desc <- c("Proporció de registres positius correctament identificats",
                 "Proporció de registres negatius correctament identificats",
                 "Proporció de registres classificats com a positius que ho són")
values <- c(sens, spec, prec)
modSum <- data.frame(pars = params, description = desc, val = values)

kable(modSum, booktabs = TRUE, 
      caption = "Mesures de la qualitat del model per la dècada dels 80", 
      col.names = c("Mesura", "Descripció", "Valor al model")) %>% 
  kable_styling(latex_options = c("striped", "hold_position"))
```


```{r}
mat90s
kable(mat90s, booktabs = TRUE, 
      caption = "Matriu de confusió amb el model pels anys 90", 
      col.names = c("No", "Yes")) %>% 
  kable_styling(latex_options = c("striped", "hold_position"))
sens <- round(sensitivity(mat90s), 3) * 100
spec <- round(specificity(mat90s), 3) * 100
prec <- round(precision(mat90s), 3) * 100
```

```{r}
kable(modSum, booktabs = TRUE, 
      caption = "Mesures de la qualitat del model per la dècada dels 90", 
      col.names = c("Mesura", "Descripció", "Valor al model")) %>% 
  kable_styling(latex_options = c("striped", "hold_position"))
```


```{r}
mat00s
kable(mat00s, booktabs = TRUE, 
      caption = "Matriu de confusió amb el model pels anys 2000", 
      col.names = c("No", "Yes")) %>% 
  kable_styling(latex_options = c("striped", "hold_position"))
sens <- round(sensitivity(mat00s), 3) * 100
spec <- round(specificity(mat00s), 3) * 100
prec <- round(precision(mat00s), 3) * 100
```

```{r}
kable(modSum, booktabs = TRUE, 
      caption = "Mesures de la qualitat del model per la dècada dels 2000", 
      col.names = c("Mesura", "Descripció", "Valor al model")) %>% 
  kable_styling(latex_options = c("striped", "hold_position"))
```


```{r}
mat10s
kable(mat10s, booktabs = TRUE, 
      caption = "Matriu de confusió amb el model pels anys 2010 fins ara", 
      col.names = c("No", "Yes")) %>% 
  kable_styling(latex_options = c("striped", "hold_position"))
sens <- round(sensitivity(mat10s), 3) * 100
spec <- round(specificity(mat10s), 3) * 100
prec <- round(precision(mat10s), 3) * 100
```

```{r}
kable(modSum, booktabs = TRUE, 
      caption = "Mesures de la qualitat del model per la dècada dels 2010 fins l'actualitat", 
      col.names = c("Mesura", "Descripció", "Valor al model")) %>% 
  kable_styling(latex_options = c("striped", "hold_position"))
```


Pel que fa als paràmetres dels nostres models, tenim la següent taula:

```{r}
params <- c("Sensitivitat", "Especificitat", "Precisió")
desc <- c("Proporció de registres positius correctament identificats",
                 "Proporció de registres negatius correctament identificats",
                 "Proporció de registres classificats com a positius que ho són")
values <- c(sens, spec, prec)
modSum <- data.frame(pars = params, description = desc, val = values)

```


Podem observar com els models que hem generat ens ofereixen una qualitat bastant baixa. Tots aquests ens diuen que només tenen una precisió del 50%. 

corba ROC

# Exercici 6: Resolució del problema.

El conjunt de dades que presentem es basa en desenes de mètriques estadístiques sobre les temporades de l'NBA i de la WNBA. Aquestes es van recollir durant la primera pràctica a partir de l'ús de tècniques de web scrapping. Aquest conjunt presenta 1900 observacions i 53 variables. En aquest, podem trobar des d'estadístiques bàsiques fins a altres més complexes sobre el joc d'un equip durant la temporada regular.

Un cop hem començat a analitzar el conjunt de dades, hem trobat que a partir de la temporada 1973-74 enrere no trobem els registres sobre estadístiques dels equips. Per tant, ens dificulta la seva anàlisi per falta d'informació. Així doncs, hem descartat aquestes temporades. Un altre fet a tenir en compte, és que els tirs de tres punts no s'inclou fins als anys 1979. Això no suposa un problema, ja que podem omplir els valors buits amb el valor 0, perquè es tracta d'un valor que representa perfectament l'estadística. Un cop realitzar els canvis, ja disposàvem d'un conjunt de dades on podíem garantir la qualitat d'aquestes. Així doncs, hem començat a analitzar aquest.

La primera anàlisi que s'ha realitzat es basava en l'evolució dels tirs de camp, fent èmfasis en els tirs de tres punts. En el conjunt, disposem d'una estadística _fg3a_per_fga_pct_ que ens permet recollir el percentatge de tirs intentats des de la distància de tres punts segons el total de tirs intentats. Així doncs, podíem veure a partir de les dades si el tir de tres punts prenia importància segons el pas de les dècades. Hem utilitzat mètodes estadístics com el test de Welch, que és una alternativa a l'ANOVA clàssic quan no hi ha homoscedasticitat i finalment, el test de Games-Howell per acabar de veure les diferències significatives entre tots els grups. Els resultats obtinguts han estat similars als resultats obtinguts en un inici amb la representació visual de la variable.

El segon anàlisi consistia a avaluar quines variables presentaven una major importància en l'estil de joc de cada dècada a partir de les correlacions entre aquestes. Per aquest cas, hem utilitzat les estadístiques més bàsiques sobre el joc, com per exemple, els tirs encertats de qualsevol distància, assistències, rebots, entre altres. Primerament, hem comprovat que una part de les variables no presentaven una distribució normal. En conseqüència hem optat per un mètode no paramètric com és el cas de la correlació de Pearson. Així doncs, com a conclusió general, hem detallat com l'estil de joc dels equips evoluciona a partir d'un joc pràcticament basat en els tirs de dos fins a arribar a un estil de joc més tàctic a partir de la combinació del joc associatiu (assistències) amb els tirs de tres punts, donant-li importància als rebots i faltes personals.

L'última anàlisi es basava en la creació d'un model que fos capaç de predir si un equip era capaç de classificar a playoffs segons les estadístiques que presentava sobre la temporada. (Falta acabar)

Finalment, podem dir que el conjunt de dades presentat ens permet assolir els objectius plantejats a l'inici d'aquesta pràctica. Si és cert que no tenim informació sobre les temporades inicials, així i tot, ens permet entendre com han evolucionat les diferents lligues segons les dècades a través de les estadístiques recollides. Hem pogut destacar diferents patrons en els estils de joc i la direcció que presenta l'estil de joc actual. És a dir, els equips estan deixant de banda els tirs de dos pels tirs de tres punts. Amb aquests s'obtenen una major puntuació, però presenten una major dificultat. Així i tot, podríem assumir que els equips estan optant per jugadors més tècnics i tiradors, en lloc d'optar per un joc físic per jugar a prop de la cistella.

# Exercici 7: Codi.

# Exercici 8: Vídeo.
