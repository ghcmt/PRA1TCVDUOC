---
title: "**Pràctica 2: Com realitzar la neteja i l'anàlisi de dades?**"
author: "Carlos Martínez Torró (cmtorro@uoc.edu) i Xavier Roca Canals (xrocaca@uoc.edu)"
date:  "`r format(Sys.time(), '%d/%m/%Y')`"
output:
  pdf_document:
    toc: yes
    highlight: tango
  html_document:
    toc: yes
    
toc-title: "Índex de la pràctica"
---

\newpage

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
```

```{r load_libraries, include=FALSE}
library(knitr)
```



# Exercici 1: Descripció del dataset

[El nostre dataset](https://zenodo.org/record/7343400) recopila desenes de mètriques estadístiques de més de 70 temporades de la NBA i de 25 anys de la WNBA, és a dir, des dels inicis respectius de cada lliga. Les dades es van recollir del web [Basketball Reference](https://www.basketball-reference.com/) (propietat del grup Sports Reference) i  estan classificades per equip i per temporada, amb un total de 1900 observacions i 53 variables. És a dir, a cada fila trobarem com li ha anat a un equip, des del punt de vista mètric, en una temporada en concret. L'ampla disponibilitat de variables ens permet anar des dels anàlisis més superficials (victòries, derrotes, punts a favor...) a altres més complexos (ritme de joc, eficiència dels llançaments...). 

En una era com la nostra en la que les dades s'han infiltrat arreu, ens preguntem si també han arribat a la lliga de bàsquet per excel·lència. L'objectiu que perseguim amb la creació i l'actual anàlisi d'aquest dataset és ambiciós: es pot explicar l'evolució de la NBA a través de les estadístiques? Hi ha algun patró que segueixin aquells equips més exitosos? I estan dirigint aquests equips l'evolució de l'esport?

# Exercici 2: Integració i selecció de les dades
A la Pràctica 1 ja vam realitzar una integració de diferents datasets creats a partir del _web scraping_, ja que estàvem interessats en diferents taules i vam optar per fer un dataframe per cadascuna d'elles i després unir els dataframes resultants per les columnes comunes (amb la funció `merge` de la llibreria `pandas`). Per tant, el dataset lliurat a la PRA1 és el que carregarem.


```{r}
# Carreguem les dades amb read.csv:
df <- read.csv("../dataset/NBA_WNBA_statistical_evolution.csv")
```

Com posar la sortida de les funcions `head`, `summary` o `str` pot allargar molt el document i resultar improductiu degut a l'elevat nombre de variables que tenim, podem crear una taula per veure la informació bàsica del dataset: quantes observacions tenim, quantes variables, quantes són numèriques, quantes categòriques, etc.

```{r}
# Carreguem kableExtra per fer la taula amb la informació bàsica. També 
# carreguem dplyr per ajudar-nos amb el filtratge de les dades:
library(kableExtra)
library(dplyr)

# Traiem les dades bàsiques del dataset:
cols <- ncol(df)
rows <- nrow(df)

# Informació del tipus de variables:
catCols <- length(names(df)[sapply(df, is.character)])
numCols <- length(names(df)[sapply(df, is.numeric)])

# I informació respecte als valors nuls, primer per cada fila:
compObs <- nrow(df %>% filter(complete.cases(.)))
compObsPct <- paste(compObs, '/', rows, ' = ', 
                      round(((compObs/rows) * 100), 2), '%')

# I per les variables:
comVars <- df %>% select_if(~ all(!is.na(.))) %>% length()
comVarsPct <- paste(comVars, '/', cols, ' = ', 
                    round(((comVars/cols) * 100), 2), '%')

# Definim el que hi haurà al dataframe:
mets <- c("Nombre d'observacions", "Nombre de variables", "Variables numèriques", 
          "Variables categòriques", "Casos complets (%) (observacions sense NAs)", 
          "Variables completes (%) (variables sense NAs)")
vals <- c(rows, cols, numCols, catCols, compObsPct, comVarsPct)

# Ho passem tot a un dataframe i formatem la taula amb Kable:
resum <- data.frame(mets, vals)
kable(resum, booktabs = TRUE, caption = "Mètriques bàsiques del dataset", 
      col.names = c("Mètrica", "Valor")) %>% 
  kable_styling(latex_options = c("striped", "hold_position"))

```

Com podem veure a la taula, hi ha un gran percentatge de casos complets (és a dir, equips amb tota la informació de l temporada completa), mentre que aproximadament el 60% de les variables no tenen cap valor NA. Podem fer una ullada a quines són les variables amb més valors perduts del nostre dataset.  

```{r}
# Apliquem sapply per obtenir els valors perduts per variable:
nas <-sapply(df, function(y) sum(length(which(is.na(y)))))

# Creem un dataframe amb els valors:
nas <- data.frame(nas)
nas <- cbind(variables = rownames(nas), data.frame(nas, row.names=NULL))

# Ordenem per valor més alt de NA:
nas <- nas[order(nas$nas, decreasing = TRUE), ]
rownames(nas) <- NULL

# Ho formatem amb kable:
kable(head(nas, 10), booktabs = TRUE, caption = "Variables amb més valors perduts", 
      col.names = c("Variable", "Valors NA")) %>% 
  kable_styling(latex_options = c("striped", "hold_position"))

```

Veiem que algunes d'aquestes variables estan relacionades amb el llançament de tres punts. Això és degut a que fins 1979 no existia aquest llançament, així que hi ha gairebé trenta anys de registres on aquestes variables tenen valor nul per definició. Per altra banda, algunes mètriques com els rebots ofensius (variable _orb_) o defensius (variable _drb_) i les pèrdues (com el percentatge del propi equip amb la variable _tov_pct_ o del contrari amb _opp_tov_pct_) també van ser estadístiques que no es recollien originalment, així que és normal que hi hagi valors perduts en aquestes. De fet, si filtrem i només agafem les observacions posteriors a la temporada 1978-79 (el llançament de tres va començar a la 1979-80) veurem que el nombre de valors perduts és molt diferent:

```{r}
df2 <- df %>% filter(Season > "1978-79")
cat("Valors perduts després de la temporada 1978-79:", sum(is.na(df2)))

```


# Exercici 3: Neteja de les dades

Com bé hem comentat en l'anterior apartat, trobem temporades en les quals ens falta informació sobre estadístiques bàsiques sobre el joc. D'aquesta forma, ens dificulta l'anàlisi sobre aquestes temporades, ja que no disposem dels elements bàsics per entendre com era l'estil o funcionament de joc de cada equip. En conseqüència, s'ha decidit descartar aquestes temporades.

## 3.1: Les dades contenen zeros o elements buits?

Així i tot, trobem temporades més antigues a l'aparició del tir de tres punts que si disposen d'aquestes estadístiques. Observant el conjunt de dades, trobem que a partir de la temporada 1973-74 disposem de tota la informació necessària. Així i tot, analitzarem quins valors buits disposem en el nostre conjunt de dades a partir d'aquesta temporada.
```{r}
df3 <- df %>% filter(Season > "1973-74")
sort(colSums(is.na(df3)), decreasing = TRUE)
```

Com era d'esperar, les úniques variables que observem amb valors buits són les que fan referència als tirs de tres punts. El que farem, és omplir aquests valors buits amb el valor 0, ja que s'ha decidit que és el valor que realment representa aquests camps. Com no existia el tir de tres no es van realitzar cap tir.

```{r}
df3$fg3[is.na(df3$fg3)] <- 0
df3$fg3_pct[is.na(df3$fg3_pct)] <- 0
df3$fg3a[is.na(df3$fg3a)] <- 0
df3$fg3a_per_fga_pct[is.na(df3$fg3a_per_fga_pct)] <- 0
```

Un altre fet a tenir en compte, és el camp `gb`. Aquesta variable ens mostra quants partits té cada equip per darrere del rival que ocupa el primer lloc. En alguns casos, aquesta informació ve representada amb el valor `-`. Entenem que aquest valor, fa referència al fet que no té cap partit per darrere dels rivals (és a dir, és l'equip que va primer de la seva divisió) i el seu valor real és 0.

```{r}
df3$gb <- as.numeric(df3$gb)
df3$gb[is.na(df3$gb)] <- 0
```

## 3.2: Identifica i gestiona els valors extrems.
En aquest cas, a partir de la funció 'summary' podem observar els mínims i màxims valors de cada variable. No s'exemplificarà en el document, ja que el gran volum de variables dificultaria la lectura del document de la pràctica. Així i tot, un cop comprovat aquest, sí que podem trobar valors molt petits en comparació a la mitjana, com pot ser el cas de victòries que ha assolit un equip en una temporada.

Ho podem veure en aquest petit exemple:
```{r}
summary(df3$wins)
```

És normal, que ens podem trobar aquests casos en múltiples variables, ja que en una mateixa temporada, els equips guanyadors presentaran valors màxims en victòries i els perdedors mínims en aquestes. En conseqüència, també es veurà reflectit en les estadístiques d'aquests equips.

El que s'ha decidit és no realitzar cap modificació, ja que aquests valors són correctes perquè es basen en dades reals sobre les temporades i les estadístiques de joc de cada un dels equips. Per tant, hem d'assumir que serà possible trobar valors que siguin _outliers_, però que haurem de tractar com un valor més. 

```{r}
summary(df)
```


# Exercici 4: Anàlisi de les dades
Abans de començar amb l'anàlisi, haurem de tenir en compte que els valors absoluts ens poden portar a error i que haurem d'optar, en general, pels relatius (percentatges o mètriques ajustades per partit o possessions). Això és degut a que la NBA i la WNBA tenen un nombre de partits totals diferents, però també perquè la pròpia NBA ha evolucionat en aquest aspecte: en el seu inici es jugaven molts menys partits. Veiem-ho amb un gràfic:

```{r}
library(ggplot2)
# Creem la columna 'games' per guardar la informació del total de partits que ha jugat cada equip:
df3$games <- df3$wins + df3$losses
df3
summary(df3$games)

# Fem el gràfic:
ggplot(data=df3, aes(x=Season, y=games, fill=League)) + geom_bar(stat="identity", color="black", position=position_dodge()) +  theme_minimal() + scale_fill_brewer(palette="Blues")
```

## 4.1: Selecció dels grups de dades que es volen analitzar/comparar.
Per seleccionar els grups de dades a comparar, farem èmfasis en els mètodes d'anàlisi que es volen realitzar per tal d'escollir quines variables/camps ens poden ajudar per donar resposta a aquests.

+ **Anàlisi estadística descriptiva**: Realitzarem una exploració de les dades per tal de veure quins equips presenten una mitjana de % de victòries més elevada durant els anys. Així doncs, ho compararem amb el percentatge de les vegades que ha estat classificat cada equip a playoffs per visualitzar la relació que poden tenir. A més, veurem l'evolució d'estadístiques bàsiques de cada temporada per veure la seva evolució i entendre quina tendència segueixen per avaluar com ha pogut canviar l'estil de joc de les grans lligues durant els anys.

+ **Anàlisi estadística inferencial**: En aquest cas, realitzarem diferents regressions entre les estadístiques bàsiques en comparació a les victòries per tal d'analitzar la importància d'aquestes en el rendiment dels equips.

+ **Model supervisat**: Finalment, realitzarem un model predictor que ens identifiqui si un equip té la possibilitat d'arribar a playoffs segons certes variables més avançades que intervenen en el joc.

Per tant, el conjunt de dades final tindria les següents variables:

**Faltaria ficar la taula. Pendent del que vulguis fer**

## 4.2: Comprovació de la normalitat i homogeneïtat de la variància.

Per tal de realitzar la comprovació de la normalitat, ens basarem en el test de Shapiro-Wilk, ja que es tracta dels més potents per contrastar aquesta. Assumirem com a hipòtesi nul·la que la població està distribuïda normalment. Direm que α=0,05, per tant, si p-valor és major a alpha, assumirem que les dades segueixen una distribució normal.

```{r}
shapiro.test(df3$fg3)
```

Seguidament, per comprovar l'homogeneïtat de la variància, ens basarem en els tests de Levene, per les que segueixen una distribució normal i Fligner-Killeen, per les que no les compleixen. Assumirem com a hipòtesi nul·la la igualtat de variàncies en els grups de dades. Direm que α=0,05, per tant, si p-valor és major a alpha, assumirem que la hipòtesi nul·la.
```{r}
library(car)
#leveneTest(wins ~ fg3, data = df3)

fligner.test(wins ~ fg3, data = df3)

```

## 4.3: Aplicació de proves estadístiques per comparar els grups de dades. Aplicar almenys tres mètodes d'anàlisi diferents. 

Seguidament, aplicarem les proves estadístiques descrites anteriorment.

### Anàlisi estadística descriptiva
Començarem agrupant el percentatge de victòries i percentatge de vegades que ha entrat a playoffs cada equip i realitzarem la mitjana a partir del nombre de temporades. D'aquesta forma, estudiarem quins equips són els equips més guanyadors durant els anys i com es veu influenciat en les classificacions als playoffs.
```{r}

#Discretitzem variable
df3$disc_playoffs[df3$Playoffs == "Yes"] <- 1
df3$disc_playoffs[df3$Playoffs == "No"] <- 0

#Filtrem per lliga
nba_wins <- df3 %>% filter(League == "NBA")
wnba_wins <- df3 %>% filter(League == "WNBA")

#Calculem quantes temporades ha jugat cada equip
nba_seasons <- nba_wins %>%
                group_by(nba_wins$Team) %>%
                tally()

wnba_seasons <- wnba_wins %>%
                group_by(wnba_wins$Team) %>%
                tally()

nba_wins <- select(nba_wins, Team, win_loss_pct, disc_playoffs)
wnba_wins <- select(wnba_wins, Team, win_loss_pct, disc_playoffs)

#Sumem els valors a estudiar
nba_wins <- aggregate(.~Team, data=nba_wins, FUN=sum)
wnba_wins <- aggregate(.~Team, data=wnba_wins, FUN=sum)

#Calculem percentatges
nba_wins$all_wins_pct <- nba_wins$win_loss_pct / nba_seasons$n
nba_wins$playoffs_pct <- nba_wins$disc_playoffs / nba_seasons$n
wnba_wins$all_wins_pct <- wnba_wins$win_loss_pct / wnba_seasons$n
wnba_wins$playoffs_pct <- wnba_wins$disc_playoffs / wnba_seasons$n

res_nba <- nba_wins %>% arrange(desc(all_wins_pct)) %>%
                    slice(1:5)

res_wnba <- wnba_wins %>% arrange(desc(all_wins_pct)) %>%
                    slice(1:5)

p1 <- ggplot(data=res_nba, aes(x=reorder(Team, -all_wins_pct), y=all_wins_pct)) + geom_bar(stat="identity", fill=rgb(0.2,0.4,0.6,0.6), position=position_dodge()) +  theme_minimal() + scale_fill_brewer(palette="Blues") + ggtitle("Equips amb millor % de victòries (NBA)") + xlab("Equip") + ylab("Percentatge")

p2 <- ggplot(data=res_wnba, aes(x=reorder(Team, -all_wins_pct), y=all_wins_pct)) + geom_bar(stat="identity", fill=rgb(0.2,0.4,0.6,0.6), position=position_dodge()) +  theme_minimal() + scale_fill_brewer(palette="Blues") + ggtitle("Equips amb millor % de victòries (WNBA)") + xlab("Equip") + ylab("Percentatge")

p3 <- ggplot(data=res_nba, aes(x=reorder(Team, -playoffs_pct), y=playoffs_pct)) + geom_bar(stat="identity", fill=rgb(0.2,0.4,0.6,0.6), position=position_dodge()) +  theme_minimal() + scale_fill_brewer(palette="Blues") + ggtitle("% de playoffs dels equips amb més victòries (NBA)") + xlab("Equip") + ylab("Percentatge")

p4 <- ggplot(data=res_wnba, aes(x=reorder(Team, -playoffs_pct), y=playoffs_pct)) + geom_bar(stat="identity", fill=rgb(0.2,0.4,0.6,0.6), position=position_dodge()) +  theme_minimal() + scale_fill_brewer(palette="Blues") + ggtitle("% de playoffs dels equips amb més victòries (WNBA)") + xlab("Equip") + ylab("Percentatge")

if(!require('xfun')) install.packages('xfun'); library('xfun')

multiplot(p1, p2, p3, p4, cols = 2)

```

Com es pot observar, veiem una alta relació en la mitjana de victòries aconseguides amb el percentatge de vegades que ha entrat l'equip a playoffs. Aquest fet pot resultar evident, ja que amb més victòries obtingudes en una temporada més possibilitats d'entrar a playoffs. Així i tot, si veiem a l'NBA, l'equip TOP 5 (Oklahoma City Thunder) té un percentatge proper a 60% de victòries i supera un 70% de vegades que ha classificat a playoffs. Per altra banda, si ho comparem amb el top 5 de la WNBA (Minnesota Lynx). Aquest té un percentatge de victòries proper al 50% i el seu % de vegades que ha entrat a playoffs és de quasi un 50% també. Fet que ens podria assegurar que aquest equip pot resultar irregular (diferència elevada de victòries/derrotes en les temporades) o que frega els límits de classificació cada temporada, fet que desemboca en aquesta irregularitat d'arribada a playoffs.

# Exercici 5: Representació dels resultats.

# Exercici 6: Resolució del problema.

# Exercici 7: Codi.

# Exercici 8: Vídeo.
